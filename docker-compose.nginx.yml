services:
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    ports:
      - "80:80"
    depends_on:
      gateway-main:
        condition: service_healthy
      grafana:
        condition: service_started
      adminer:
        condition: service_started
    restart: always
    environment:
      - NGINX_HOST=localhost
      - NGINX_PORT=80

  gateway-main:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - ASPNETCORE_URLS=http://*:5001
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5001
      - ServiceUrls__CoreService=http://core-service:5002
    expose:
      - "5001"
    depends_on:
      core-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./monitoring:/app/monitoring

  gateway-ro1:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - ASPNETCORE_URLS=http://*:5004
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5004
      - ServiceUrls__CoreService=http://core-service-ro1:5006
      - ReadOnly=true
    expose:
      - "5004"
    depends_on:
      core-service-ro1:
        condition: service_healthy
    volumes:
      - ./monitoring:/app/monitoring

  gateway-ro2:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - ASPNETCORE_URLS=http://*:5005
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5005
      - ServiceUrls__CoreService=http://core-service-ro2:5007
      - ReadOnly=true
    expose:
      - "5005"
    depends_on:
      core-service-ro2:
        condition: service_healthy
    volumes:
      - ./monitoring:/app/monitoring

  gateway-mirror-main:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - ASPNETCORE_URLS=http://*:5011
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5011
      - ServiceUrls__CoreService=http://core-service:5002
      - PathBase=/mirror
    expose:
      - "5011"
    depends_on:
      core-service:
        condition: service_healthy
    volumes:
      - ./monitoring:/app/monitoring

  gateway-mirror-ro1:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - ASPNETCORE_URLS=http://*:5014
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5014
      - ServiceUrls__CoreService=http://core-service-ro1:5006
      - ReadOnly=true
      - PathBase=/mirror
    expose:
      - "5014"
    depends_on:
      core-service-ro1:
        condition: service_healthy
    volumes:
      - ./monitoring:/app/monitoring

  gateway-mirror-ro2:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    environment:
      - ASPNETCORE_URLS=http://*:5015
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5015
      - ServiceUrls__CoreService=http://core-service-ro2:5007
      - ReadOnly=true
      - PathBase=/mirror
    expose:
      - "5015"
    depends_on:
      core-service-ro2:
        condition: service_healthy
    volumes:
      - ./monitoring:/app/monitoring

  core-service:
    build:
      context: .
      dockerfile: Dockerfile.core
    environment:
      - ASPNETCORE_URLS=http://*:5002
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5002
      - ServiceUrls__DataService=http://data-service:5003
    expose:
      - "5002"
    depends_on:
      data-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/core/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./monitoring:/app/monitoring

  core-service-ro1:
    build:
      context: .
      dockerfile: Dockerfile.core
    environment:
      - ASPNETCORE_URLS=http://*:5006
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5006
      - ServiceUrls__DataService=http://data-service-ro1:5008
      - ReadOnly=true
    expose:
      - "5006"
    depends_on:
      data-service-ro1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/core/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./monitoring:/app/monitoring

  core-service-ro2:
    build:
      context: .
      dockerfile: Dockerfile.core
    environment:
      - ASPNETCORE_URLS=http://*:5007
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5007
      - ServiceUrls__DataService=http://data-service-ro2:5009
      - ReadOnly=true
    expose:
      - "5007"
    depends_on:
      data-service-ro2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5007/core/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./monitoring:/app/monitoring

  data-service:
    build:
      context: .
      dockerfile: Dockerfile.data
    environment:
      - ConnectionStrings__DataBaseConnect=User ID=postgres;Password=postgres;Host=postgres-primary;Database=Eventity;Port=5432
      - ASPNETCORE_URLS=http://*:5003
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5003
    expose:
      - "5003"
    depends_on:
      - postgres-primary
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/data/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./monitoring:/app/monitoring

  data-service-ro1:
    build:
      context: .
      dockerfile: Dockerfile.data
    environment:
      - ConnectionStrings__DataBaseConnect=User ID=postgres;Password=postgres;Host=postgres-replica;Database=Eventity;Port=5432;Options=-c default_transaction_read_only=on
      - ASPNETCORE_URLS=http://*:5008
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5008
      - ReadOnly=true
    expose:
      - "5008"
    depends_on:
      - postgres-replica
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5008/data/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./monitoring:/app/monitoring

  data-service-ro2:
    build:
      context: .
      dockerfile: Dockerfile.data
    environment:
      - ConnectionStrings__DataBaseConnect=User ID=postgres;Password=postgres;Host=postgres-replica;Database=Eventity;Port=5432;Options=-c default_transaction_read_only=on
      - ASPNETCORE_URLS=http://*:5009
      - Kestrel__Endpoints__Http__Url=http://0.0.0.0:5009
      - ReadOnly=true
    expose:
      - "5009"
    depends_on:
      - postgres-replica
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5009/data/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./monitoring:/app/monitoring

  postgres-primary:
    image: bitnami/postgresql:latest
    environment:
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: postgres
      POSTGRESQL_DATABASE: Eventity
      POSTGRESQL_REPLICATION_MODE: master
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_pass
    volumes:
      - postgres_primary_data:/bitnami/postgresql
      - ./scripts:/docker-entrypoint-initdb.d

  postgres-replica:
    image: bitnami/postgresql:latest
    depends_on:
      - postgres-primary
    environment:
      POSTGRESQL_REPLICATION_MODE: slave
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_pass
      POSTGRESQL_MASTER_HOST: postgres-primary
      POSTGRESQL_MASTER_PORT_NUMBER: 5432
      POSTGRESQL_PASSWORD: postgres
    volumes:
      - postgres_replica_data:/bitnami/postgresql

  adminer:
    image: adminer:4.8.1
    environment:
      ADMINER_DEFAULT_SERVER: postgres-primary
      ADMINER_DESIGN: dracula
    expose:
      - "8080"
    depends_on:
      - postgres-primary

  loki:
    image: grafana/loki:2.9.8
    command: -config.file=/etc/loki/config.yml
    volumes:
      - ./monitoring/loki-config.yml:/etc/loki/config.yml
      - loki_data:/loki

  promtail:
    image: grafana/promtail:2.9.8
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml
      - ./monitoring:/var/log/eventity
      - promtail_positions:/tmp/positions
    depends_on:
      - loki

  grafana:
    image: grafana/grafana:10.4.2
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SERVER_ROOT_URL: "http://localhost/monitoring/"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - loki

volumes:
  postgres_primary_data:
  postgres_replica_data:
  grafana_data:
  loki_data:
  promtail_positions:
