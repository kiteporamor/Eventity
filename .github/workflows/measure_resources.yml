name: Measure resources

on:
  push:
    branches: [ main, Test5 ]
  pull_request:
  workflow_dispatch:

jobs:
  measure:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: EventityTest
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Install time tool
        run: |
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            brew update || true
            brew install gnu-time || true
          else
            sudo apt-get update
            sudo apt-get install -y time
          fi

      - name: Make measurement script executable
        run: chmod +x scripts/measure_resources.sh

      - name: Run resource measurement
        env:
          # run integration tests against the Postgres service container
          TEST_DB_HOST: postgres
          # optional: override COMMAND to run a different test/benchmark
          COMMAND: ${COMMAND:-dotnet test src/Eventity.Tests.Integration/Eventity.Tests.Integration.csproj}
        run: ./scripts/measure_resources.sh

      - name: Upload resource artifacts
        uses: actions/upload-artifact@v4
        with:
          name: resource-artifacts-${{ matrix.os }}
          path: |
            artifacts/resource
            artifacts/allure-results
