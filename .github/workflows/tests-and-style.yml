name: Tests and Static Analysis

on:
  push:
    branches: [ main, Test6 ]
  pull_request:
    branches: [ main ]

jobs:
  static-analysis:
    name: Code Style & Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Confirm dotnet
        run: dotnet --info

      - name: Run static analysis script (filters only CA1502/StyleCop)
        run: bash scripts/check_static_analysis.sh

  test:
    name: Run Tests (Docker Compose)
    needs: static-analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Build and run tests with Docker Compose
        uses: docker/compose-action@v4
        with:
          files: docker-compose.test.yml
          args: up --build --abort-on-container-exit

      - name: Tear down Docker Compose
        if: always()
        uses: docker/compose-action@v4
        with:
          files: docker-compose.test.yml
          args: down

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            src/test-results/
            src/Eventity.Tests.Integration/artifacts/allure-results/
            src/allure-report/
          retention-days: 30

      - name: Generate Allure Report
        if: always()
        run: |
          if command -v allure >/dev/null 2>&1; then
            mkdir -p src/allure-report
            allure generate src/Eventity.Tests.Integration/artifacts/allure-results -o src/allure-report --clean || true
          else
            echo "Allure not found, skipping report generation"
          fi

      - name: Deploy Allure Report to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: src/allure-report
          destination_dir: allure-report

      - name: Upload network capture
        uses: actions/upload-artifact@v4
        with:
          name: network-capture
          path: src/test-results/db-traffic.pcapng
          retention-days: 7
