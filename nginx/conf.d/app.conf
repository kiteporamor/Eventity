upstream backend_write {
    server eventity-app:5001;
}

upstream backend_read {
    server eventity-app:5001 weight=2;
    server eventity-app-readonly-1:5002 weight=1;
    server eventity-app-readonly-2:5003 weight=1;
}

upstream backend_mirror {
    server eventity-app-mirror:5004;
}

server {
    listen 80;
    server_name _;
    server_tokens off;
    
    location / {
        proxy_pass http://backend_write;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Server-Name "Eventity Application";
        
        proxy_cache my_cache;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        proxy_cache_bypass $http_cache_control;
        add_header X-Cache-Status $upstream_cache_status;
    }

    location /api/v1/ {
        if ($request_method = GET) {
            proxy_pass http://backend_read;
            break;
        }
        
        if ($request_method ~ ^(POST|PUT|PATCH|DELETE)$) {
            proxy_pass http://backend_write;
            break;
        }
        
        proxy_pass http://backend_write;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Server-Name "Eventity API";
        
        error_page 502 503 504 = @write_error;
        proxy_intercept_errors on;
    }
    
    location /mirror/ {
        proxy_pass http://backend_mirror/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /mirror;
        proxy_set_header X-Server-Name "Eventity Mirror";
        
        proxy_redirect off;
        
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            proxy_pass http://backend_mirror;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    location = /monitoring {
        return 301 /monitoring/;
    }

    location ^~ /monitoring/ {
        proxy_pass http://grafana:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-Port $server_port;

        proxy_redirect off;
    }

    location /loki/ {
        proxy_pass http://loki:3100/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location ~* \.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
        root /usr/share/nginx/html/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Server-Name "Eventity Static";
        
        try_files $uri =404;
    }

    location @write_error {
        add_header Content-Type application/json;
        add_header X-Server-Name "Eventity Error Handler";
        return 503 '{"error": "Service unavailable", "message": "Write operation is not allowed on read-only instance", "timestamp": "$time_iso8601"}';
    }

    location /nginx_status {
        stub_status on;
        access_log off;
        allow all;
    }

    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
