resolver 127.0.0.11 valid=10s;

upstream gateway_read {
    zone gateway_read 64k;
    server gateway-main:5001 weight=2 resolve;
    server gateway-ro1:5004 weight=1 resolve;
    server gateway-ro2:5005 weight=1 resolve;
}

upstream gateway_write {
    zone gateway_write 64k;
    server gateway-main:5001 resolve;
}

upstream gateway_mirror_read {
    zone gateway_mirror_read 64k;
    server gateway-mirror-main:5011 weight=2 resolve;
    server gateway-mirror-ro1:5014 weight=1 resolve;
    server gateway-mirror-ro2:5015 weight=1 resolve;
}

upstream gateway_mirror_write {
    zone gateway_mirror_write 64k;
    server gateway-mirror-main:5011 resolve;
}

map $request_method $gateway_upstream {
    default "http://gateway_write$request_uri";
    GET "http://gateway_read$request_uri";
    HEAD "http://gateway_read$request_uri";
}

map $request_method $gateway_mirror_upstream {
    default "http://gateway_mirror_write$request_uri";
    GET "http://gateway_mirror_read$request_uri";
    HEAD "http://gateway_mirror_read$request_uri";
}

server {
    listen 80;
    server_name _;

    proxy_hide_header Server;
    add_header Server Eventity always;

    location ~ ^/api/v(1|2)/ {
        proxy_pass $gateway_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    location ~ ^/mirror/api/v(1|2)/ {
        proxy_pass $gateway_mirror_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    location /swagger/ {
        proxy_pass http://gateway_write/swagger/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache static_cache;
        proxy_cache_methods GET HEAD;
        proxy_cache_valid 200 10m;
        add_header X-Cache-Status $upstream_cache_status;
    }

    location /mirror/swagger/ {
        proxy_pass http://gateway_mirror_write/mirror/swagger/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache static_cache;
        proxy_cache_methods GET HEAD;
        proxy_cache_valid 200 10m;
        add_header X-Cache-Status $upstream_cache_status;
    }

    location = /api/v1 {
        return 302 /swagger;
    }

    location = /mirror/api/v1 {
        return 302 /mirror/swagger;
    }

    location /monitoring/ {
        proxy_pass http://grafana:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /monitoring;
        proxy_redirect off;
    }

    location = /monitoring {
        return 301 /monitoring/;
    }

    location /static/ {
        alias /usr/share/nginx/html/static/;
        try_files $uri $uri/ =404;

        location ~* \.(png|jpg|jpeg|gif|svg|ico)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    location /mirror/static/ {
        alias /usr/share/nginx/html/static/;
        try_files $uri $uri/ =404;

        location ~* \.(png|jpg|jpeg|gif|svg|ico)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    location /legacy {
        alias /usr/share/nginx/html/static/legacy/;
        try_files $uri $uri/ /index.html =404;
    }

    location /mirror/legacy {
        alias /usr/share/nginx/html/static/legacy/;
        try_files $uri $uri/ /index.html =404;
    }

    location /documentation {
        alias /usr/share/nginx/html/static/;
        try_files /documentation.html =404;
        index documentation.html;
        default_type text/html;
    }

    location /mirror/documentation {
        alias /usr/share/nginx/html/static/;
        try_files /documentation.html =404;
        index documentation.html;
        default_type text/html;
    }

    location /README.md {
        alias /usr/share/nginx/html/README.md;
        default_type text/plain;
        add_header Content-Type "text/plain; charset=utf-8";
    }

    location /mirror/README.md {
        alias /usr/share/nginx/html/README.md;
        default_type text/plain;
        add_header Content-Type "text/plain; charset=utf-8";
    }

    location /docs/ {
        alias /usr/share/nginx/html/docs/;
        try_files $uri $uri/ =404;
        location ~* \.(png|jpg|jpeg|gif|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    location /mirror/docs/ {
        alias /usr/share/nginx/html/docs/;
        try_files $uri $uri/ =404;
        location ~* \.(png|jpg|jpeg|gif|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    location /admin/ {
        proxy_pass http://adminer:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect / /admin/;

        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
    }

    location /status-data {
        stub_status on;
        access_log off;
        allow all;
    }

    location /status {
        alias /usr/share/nginx/html/static/;
        try_files /status.html =404;
    }

    location /mirror/status {
        alias /usr/share/nginx/html/static/;
        try_files /status.html =404;
    }

    location /managment {
        alias /usr/share/nginx/html/static/;
        try_files /management.html /index.html;
    }

    location /mirror/managment {
        alias /usr/share/nginx/html/static/;
        try_files /management.html /index.html;
    }

    location /reserved/ {
        alias /usr/share/nginx/html/static/;
        try_files $uri $uri/ /index.html;
    }

    location /mirror/reserved/ {
        alias /usr/share/nginx/html/static/;
        try_files $uri $uri/ /index.html;
    }

    location /mirror/ {
        rewrite ^/mirror/(.*)$ /$1 break;
        root /usr/share/nginx/html/static;
        try_files $uri $uri/ /index.html;
    }

    location / {
        root /usr/share/nginx/html/static;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    error_page 404 /static/404.html;
    error_page 500 502 503 504 /static/50x.html;
}
